<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>YubiKey OpenPGP &amp; SSH 使用指南</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href=".asciidoctor/asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href=".asciidoctor/rouge-github.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>YubiKey OpenPGP &amp; SSH 使用指南</h1>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_准备">准备</a></li>
<li><a href="#_重置">重置</a></li>
<li><a href="#_openpgp">OpenPGP</a>
<ul class="sectlevel2">
<li><a href="#_生成_gpg_密钥">生成 GPG 密钥</a></li>
</ul>
</li>
<li><a href="#_参考链接">参考链接</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>已经入手 YubiKey 5 NFC 约有一年了期间折腾过几次，也真正用过一段时间。
但最终还是因为不如本地密钥文件方便，最终被搁置吃灰，一直想再捣腾一下使用起来。
前几天因为想要使用 hledger 和 git-crypt 记账记日记需要用到 GPG，Git 提交签名也需要用到 GPG，
而平时提交代码和服务器登录需要用到 SSH。
准备使用 YubiKey 存储对应的密钥。
所以做了这篇记录，方便日后参考。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_准备">准备</h2>
<div class="sectionbody">
<div class="paragraph">
<p>首先安装稍后我们需要用到的 <a href="https://github.com/Yubico/yubikey-manager">YubiKey Manager</a>、https://gnupg.org/[GnuPG]等软件。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">sudo </span>pacman <span class="nt">-S</span> yubikey-manager gnupg pcsclite ccid</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_重置">重置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>YubiKey 5 系列和 YubiKey 5 FIPS 系列的各种应用是相互隔离的，需要单独进行重置。</p>
</div>
<div class="paragraph">
<p>可以通过以下命令查看 Key 的相关信息。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ykman info</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">Device type: YubiKey 5 NFC
Serial number: ********
Firmware version: 5.*.*
Form factor: Keychain (USB-A)
Enabled USB interfaces: OTP, FIDO, CCID
NFC transport is enabled.

Applications	USB          	NFC
FIDO2       	Enabled      	Enabled
OTP         	Enabled      	Enabled
FIDO U2F    	Enabled      	Enabled
OATH        	Enabled      	Enabled
YubiHSM Auth	Not available	Not available
OpenPGP     	Enabled      	Enabled
PIV         	Enabled      	Enabled</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>FIDO2</p>
<div class="listingblock">
<div class="title">使用以下命令对 FIDO2 应用进行重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ykman fido reset</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
重置 FIDO 应用时 FIDO U2F 应用也会被重置。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">然后输入 <code>y</code> 确认重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">WARNING! This will delete all FIDO credentials, including FIDO U2F credentials, and restore factory settings. Proceed? [y/N]: y</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">最后根据提示重新插拔 YubiKey 后轻触 YubiKey 完成重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">Remove and re-insert your YubiKey to perform the reset...
  Touch your YubiKey...</code></pre>
</div>
</div>
</li>
<li>
<p>OATH</p>
<div class="listingblock">
<div class="title">使用以下命令对 OATH 应用进行重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ykman oath reset</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">然后输入 <code>y</code> 确认即可完成重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">WARNING! This will delete all stored OATH accounts and restore factory settings. Proceed? [y/N]: y
Resetting OATH data...
Success! All OATH accounts have been deleted from the YubiKey.</code></pre>
</div>
</div>
</li>
<li>
<p>OpenPGP</p>
<div class="listingblock">
<div class="title">使用以下命令对 OpenPGP 应用进行重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ykman openpgp reset</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">然后输入 <code>y</code> 确认即可完成重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">WARNING! This will delete all stored OpenPGP keys and data and restore factory settings? [y/N]: y
Resetting OpenPGP data, don't remove the YubiKey...
Success! All data has been cleared and default PINs are set.
PIN:         123456
Reset code:  NOT SET
Admin PIN:   12345678</code></pre>
</div>
</div>
</li>
<li>
<p>OTP</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
我使用的是YubiKey 5 NFC 所以我需要清除两个槽（1 和 2）中的盐。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">使用以下命令删除相应槽中的盐</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ykman otp delete 1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">然后输入 <code>y</code> 确认即可完成删除</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">Do you really want to delete the configuration of slot 1? [y/N]: y
Deleting the configuration in slot 1...</code></pre>
</div>
</div>
</li>
<li>
<p>PIV</p>
<div class="listingblock">
<div class="title">使用以下命令对 PIV 应用进行重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ykman piv reset</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">然后输入 <code>y</code> 确认即可完成重置</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">WARNING! This will delete all stored PIV data and restore factory settings. Proceed? [y/N]: y
Resetting PIV data...
Success! All PIV data have been cleared from the YubiKey.
Your YubiKey now has the default PIN, PUK and Management Key:
	PIN:	123456
	PUK:	12345678
	Management Key:	************************************************</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_openpgp">OpenPGP</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_生成_gpg_密钥">生成 GPG 密钥</h3>
<div class="sect3">
<h4 id="_准备工作">准备工作</h4>
<div class="paragraph">
<p>创建临时工作目录</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">export </span><span class="nv">GNUPGHOME</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span> <span class="nt">-t</span> gnupg_<span class="si">$(</span><span class="nb">date</span> +%Y%m%d%H%M<span class="si">)</span>_XXX<span class="si">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>下载加固后的 GPG 配置</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">wget <span class="nt">-O</span> <span class="nv">$GNUPGHOME</span>/gpg.conf https://raw.githubusercontent.com/drduh/config/master/gpg.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>之后的步骤中你将会被多次要求输入密码进行认证 —— 请保持它触手可得。</p>
</div>
<div class="paragraph">
<p>首先生成一个强密码然后你可以把它记住或者写下来。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">gpg <span class="nt">--gen-random</span> <span class="nt">--armor</span> 0 24</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_创建主密钥">创建主密钥</h4>
<div class="paragraph">
<p>首先我们来创建主密钥。
主密钥只用来进行证书签发：其签发的子密钥被用来加密，签名及认证。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
注意任何时刻主密钥都应该保持离线，并且只在用来撤销或签发新的子密钥时进行访问。
密钥也可以由 YubiKey 自身生成从而保证不会有任何其它副本存在。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>生成主密钥</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">gpg <span class="nt">--expert</span> <span class="nt">--full-generate-key</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext"></code></pre>
</div>
</div>
<div class="paragraph">
<p>WARN: 将证书保存在持久，且安全的地方因为它会在证书过期后用来签发新的子证书和为其他 YubiKey 提供密钥。</p>
</div>
</div>
<div class="sect3">
<h4 id="_创建子证书">创建子证书</h4>
<div class="paragraph">
<p>下面我们通过编辑主证书来为其添加子证书：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">gpg <span class="nt">--export</span> <span class="nt">--edit-key</span> <span class="nv">$KEYID</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">Secret key is available.

sec  rsa4096/0xEA5DE91459B80592
    created: 2017-10-09  expires: never       usage: C
    trust: ultimate      validity: ultimate
[ultimate] (1). Dr Duh &lt;doc@duh.to&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_创建签名证书">创建签名证书</h5>

</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_参考链接">参考链接</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.yubico.com/blog/github-now-supports-ssh-security-keys/">GitHub now supports ssh security keys</a></p>
</div>
<div class="paragraph">
<p><a href="https://flyhigher.top/develop/2160.html">谈谈 WebAuthn</a></p>
</div>
<div class="paragraph">
<p><a href="https://2fa.directory/">2FA directory</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/drduh/YubiKey-Guide">YubiKey Guide</a></p>
</div>
<div class="paragraph">
<p><a href="https://bitbili.net/yubikey_5_nfc_functions.html">详解 Yubikey 5 NFC 的工作原理</a></p>
</div>
<div class="paragraph">
<p><a href="https://developers.yubico.com/">Yubico Developers</a></p>
</div>
</div>
</div>
</div>
</body>
</html>